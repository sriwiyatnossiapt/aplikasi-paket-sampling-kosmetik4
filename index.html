<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Paket Sampling 2026 - Versi Database Terintegrasi</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        #dashboard { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 50px; }
        .card { 
            background: white; width: 220px; padding: 30px; border-radius: 15px; 
            text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: 0.3s; border: 1px solid #ddd;
        }
        .card:hover { transform: translateY(-5px); border-color: #3498db; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .card h2 { font-size: 40px; margin-bottom: 10px; }

        .content-section { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
        .active { display: block !important; }

        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .input-item { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #2c3e50; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: white; }
        input:focus { border-color: #3498db; outline: none; }

        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #3498db; color: white; }
        
        .btn { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-back { background: #7f8c8d; color: white; margin-bottom: 20px; }
        .btn-save { background: #27ae60; color: white; width: 100%; margin-top: 20px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-save:disabled { background: #95a5a6; cursor: not-allowed; }
        .btn-danger { background: #e74c3c; color: white; padding: 8px 15px; font-size: 12px; }
        .loading-text { color: #3498db; font-weight: bold; font-style: italic; }
    </style>
</head>
<body>

    <div class="header">
        <h1>PAKET SAMPLING 2026</h1>
        <p>Sistem Input Database Terintegrasi Google Sheets</p>
    </div>

    <div id="dashboard" class="active">
        <div class="card" onclick="tampilkanHalaman('input-data')"><h2>üìù</h2><h3>1. Input Data</h3></div>
        <div class="card" onclick="tampilkanHalaman('renlak')"><h2>üìÖ</h2><h3>2. Renlak 2026</h3></div>
        <div class="card" onclick="tampilkanHalaman('rekap')"><h2>üìä</h2><h3>3. Rekap Cloud</h3></div>
    </div>

    <div id="input-data" class="content-section">
        <button class="btn btn-back" onclick="kembaliKeMenu()">‚Üê Dashboard</button>
        <h2>Form Input Database Sampling</h2>
        <div class="form-group">
            <div class="input-item"> <label>A. No. Urut (Otomatis)</label> <input type="text" id="noUrut" readonly style="background: #e9ecef; font-weight: bold; color: #2c3e50;"></div>
            <div class="input-item"><label>B. Tanggal Sampling</label><input type="date" id="tglOtomatis"></div>
            <div class="input-item"><label>C. Nama Produk (Brand/Merk)</label><input type="text" id="namaProduk" placeholder="Contoh: MS Glow Whitening Cream"></div>
            
            <div class="input-item">
                <label>D. Kategori</label>
                <select id="kategori" onchange="updateSubKategori()">
                    <option value="">-- Pilih Kategori --</option>
                    <option value="1">Kosmetik Beresiko Tinggi</option>
                    <option value="2">Kosmetik riwayat TMS</option>
                    <option value="3">Sampling Mandiri UPT</option>
                    <option value="4">Produksi Tiongkok</option>
                    <option value="5">Kontrak Produksi</option>
                    <option value="6">Kuasa Merek</option>
                    <option value="7">Menengah ke bawah / Viral</option>
                    <option value="8">Online Official Store</option>
                    <option value="9">Klaim Komposisi Tertentu</option>
                    <option value="10">DNA porcine</option>
                </select>
            </div>

            <div class="input-item">
                <label>E. Sub Kategori</label>
                <select id="subKategori"><option value="">-- Pilih Kategori Dulu --</option></select>
            </div>

            <div class="input-item"><label>F. Sub Sub Kategori</label><input type="text" id="subSub" placeholder="-"></div>
            
            <div class="input-item">
                <label>G. Metode Sampling</label>
                <select id="metode"><option>offline</option><option>online</option><option>Lainnya</option></select>
            </div>

            <div class="input-item"><label>H. NIE (Nomor Izin Edar)</label><input type="text" id="nie" placeholder="NA123456789"></div>
            <div class="input-item"><label>I. Nomor Batch</label><input type="text" id="noBatch"></div>
            <div class="input-item"><label>J. Expired Date (ED)</label><input type="date" id="ed"></div>
            <div class="input-item"><label>K. Tempat Sampling</label><input type="text" id="tempat" placeholder="Nama Toko/Borma/Griya"></div>
            <div class="input-item"><label>L. Auto Bulan</label><input type="text" id="autoBulan" readonly style="background: #e9ecef;"></div>
            <div class="input-item"><label>M. Petugas</label><input type="text" id="petugas" placeholder="Nama Petugas"></div>
        </div>
        <button class="btn btn-save" id="btnSimpan" onclick="simpanData()">Simpan ke Google Sheets</button>
    </div>

    <div id="renlak" class="content-section">
        <button class="btn btn-back" onclick="kembaliKeMenu()">‚Üê Kembali</button>
        <h2>Rencana Pelaksanaan (Renlak) 2026</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Kategori</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>Mei</th><th>Jun</th><th>Jul</th><th>Agu</th><th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th></tr></thead>
                <tbody id="tabelRenlakBody"></tbody>
            </table>
        </div>
    </div>

    <div id="rekap" class="content-section">
        <button class="btn btn-back" onclick="kembaliKeMenu()">‚Üê Kembali</button>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Data Terkoneksi Google Sheets</h2>
            <button class="btn btn-danger" onclick="tampilkanRekap(true)">üîÑ Segarkan Data</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Tanggal</th>
                        <th>Produk</th>
                        <th>Kategori</th>
                        <th>Tempat</th>
                        <th>Bulan</th>
                        <th>Petugas</th>
                    </tr>
                </thead>
                <tbody id="rekapBody">
                    <tr><td colspan="7">Klik "Segarkan Data" untuk memuat...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // GANTI URL INI DENGAN URL DEPLOY ANDA
        const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycbybak0m1wUhbgDkwvaFIu8O4FoAEJJ45nTjd3tsGeYQdytQeExmURnc_v5zlgU7r7MU/exec";

        let cacheRekap = null; // Menyimpan data di memori agar tidak download terus-menerus

        const subKategoriData = {
            "1": ["Sediaan bayi", "Sediaan perawatan wajah", "Sediaan rias mata", "Sediaan rias wajah", "Sediaan rias bibir", "Sediaan parfum", "Sediaan pewarna kuku"],
            "2": ["Sediaan untuk alis", "Eye shadow", "Eye liner", "Blush on", "Bedak padat", "Pembersih kulit muka", "Mascara", "Lipstik", "Krim pencerah"],
            "3": ["Bedak Badan", "Lip Care", "Mouthwashes", "Kondisioner", "Sampo", "Sabun Bayi", "Anti Aging", "Prioritas"],
            "4": ["Krim malam", "Krim Siang", "Masker Wajah", "Bedak padat", "Lipstik", "Moisturiser", "Parfume"],
            "5": ["Day Cream", "Night Cream", "Tabir surya", "Skin aging", "Pembersih wajah", "Pencerah"],
            "6": ["Day Cream", "Night Cream", "Hand Body Lotion", "Parfume", "Penyegar", "Baby hair wash"],
            "7": ["Bedak Badan", "Lipstik", "Deodoran", "Acne care"],
            "8": ["Lip colour", "Skin aging product", "Day Cream", "Night Cream", "Pelembab"],
            "9": ["Baby cream", "Sediaan bayi lainnya", "Sediaan tabir surya"],
            "10": ["Pelembab/moisturizer"]
        };

        // Event Listener Tanggal
        document.getElementById('tglOtomatis').addEventListener('change', function() {
            const daftarBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            if(this.value) {
                const tgl = new Date(this.value);
                document.getElementById('autoBulan').value = daftarBulan[tgl.getMonth()];
            }
        });

        function updateSubKategori() {
            const kat = document.getElementById("kategori").value;
            const sub = document.getElementById("subKategori");
            sub.innerHTML = '<option value="">-- Pilih Sub Kategori --</option>';
            if (kat && subKategoriData[kat]) {
                subKategoriData[kat].forEach(s => {
                    let opt = document.createElement("option");
                    opt.value = s; opt.text = s; sub.appendChild(opt);
                });
            }
        }

        async function simpanData() {
    const btn = document.getElementById('btnSimpan');
    
    // Validasi dasar agar data tidak kosong
    if(!document.getElementById('namaProduk').value || !document.getElementById('tglOtomatis').value) {
        return alert("Mohon isi Nama Produk dan Tanggal!");
    }

    const data = {
        action: "insert",
        no: document.getElementById('noUrut').value,
        tgl: document.getElementById('tglOtomatis').value,
        nama: document.getElementById('namaProduk').value,
        kat: document.getElementById('kategori').options[document.getElementById('kategori').selectedIndex].text,
        sub: document.getElementById('subKategori').value,
        subsub: document.getElementById('subSub').value,
        metode: document.getElementById('metode').value,
        nie: document.getElementById('nie').value,
        batch: document.getElementById('noBatch').value,
        ed: document.getElementById('ed').value,
        tempat: document.getElementById('tempat').value,
        bulan: document.getElementById('autoBulan').value,
        petugas: document.getElementById('petugas').value
    };

    btn.disabled = true;
    btn.innerText = "Mengirim...";

    try {
        // Mengirim data ke Google Sheets
        await fetch(URL_GOOGLE_SCRIPT, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(data)
        });
        
        alert("Berhasil! Data telah disimpan.");
        
        // --- PROSES PEMBERSIHAN (RESET) ---
        cacheRekap = null; // Reset cache rekap agar data terbaru masuk
        resetForm();       // Panggil fungsi kosongkan kotak
        
        // --- AMBIL NOMOR URUT BARU ---
        // Kita panggil lagi fungsi ini agar No Urut otomatis naik ke angka selanjutnya
        await tampilkanHalaman('input-data'); 
        
    } catch (err) {
        alert("Gagal menyimpan: " + err);
    } finally {
        btn.disabled = false;
        btn.innerText = "Simpan ke Google Sheets";
    }
}

// FUNGSI BARU: Membersihkan semua kotak inputan
function resetForm() {
    // Daftar ID yang ingin dikosongkan
    const inputIds = [
        'namaProduk', 'subSub', 'nie', 'noBatch', 
        'ed', 'tempat', 'petugas'
    ];
    
    inputIds.forEach(id => {
        document.getElementById(id).value = "";
    });

    // Reset Pilihan (Dropdown)
    document.getElementById('kategori').value = "";
    document.getElementById('subKategori').innerHTML = '<option value="">-- Pilih Kategori Dulu --</option>';
    document.getElementById('metode').selectedIndex = 0; // Kembali ke 'Rutin'
    
    // Note: No Urut & Tanggal tidak direset di sini karena diatur ulang oleh tampilkanHalaman()
}

        async function tampilkanRekap(forceRefresh = false) {
            const rb = document.getElementById('rekapBody');
            
            // Jika data sudah ada di memori, langsung tampilkan (Sangat Cepat)
            if (cacheRekap && !forceRefresh) {
                renderTabel(cacheRekap);
                return;
            }

            rb.innerHTML = '<tr><td colspan="7" class="loading-text">‚ö° Menghubungkan ke Server Google...</td></tr>';

            try {
                const response = await fetch(URL_GOOGLE_SCRIPT + "?action=read&t=" + new Date().getTime());
                const data = await response.json();
                cacheRekap = data;
                renderTabel(data);
            } catch (error) {
                rb.innerHTML = `<tr><td colspan="7" style="color:red;">Gagal memuat: Pastikan URL Apps Script Benar & Izin 'Anyone'.</td></tr>`;
            }
        }

        function renderTabel(data) {
            const rb = document.getElementById('rekapBody');
            if (!data || data.length === 0) {
                rb.innerHTML = '<tr><td colspan="7">Database kosong.</td></tr>';
                return;
            }

            // Gabungkan semua baris menjadi satu string (Lebih cepat daripada looping innerHTML)
            const html = data.map(row => `
                <tr>
                    <td>${row[0] || ''}</td>
                    <td>${row[1] ? row[1].split('T')[0] : ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${row[10] || ''}</td>
                    <td>${row[11] || ''}</td>
                    <td>${row[12] || ''}</td>
                </tr>
            `).join('');
            
            rb.innerHTML = html;
        }

        async function tampilkanHalaman(id) {
    document.getElementById('dashboard').classList.remove('active');
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    if(id === 'input-data') {
        // 1. Set tanggal hari ini
        document.getElementById('tglOtomatis').valueAsDate = new Date();
        document.getElementById('tglOtomatis').dispatchEvent(new Event('change'));
        
        // 2. Ambil No Urut Berikutnya dari Server
        const inputNo = document.getElementById('noUrut');
        inputNo.value = "‚è≥..."; 

        try {
            // Tambahkan cache breaker agar selalu ambil data terbaru
            const response = await fetch(URL_GOOGLE_SCRIPT + "?action=get_next_no&t=" + new Date().getTime());
            const nextNo = await response.text();
            inputNo.value = nextNo;
        } catch (err) {
            inputNo.value = "Error";
            console.error("Gagal sinkron nomor:", err);
        }
    }
    
    if(id === 'rekap') {
        tampilkanRekap();
    }
}

        function kembaliKeMenu() {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
        }

        // Init Tabel Renlak
        const cats = ["Kosmetik Beresiko Tinggi","Kosmetik riwayat TMS","Sampling Mandiri UPT","Produksi Tiongkok"," Kontrak Produksi","Kuasa Merek","Menengah ke bawah / Viral","Online Official Store","Klaim Komposisi Tertentu","DNA porcine"];
        const trb = document.getElementById('tabelRenlakBody');
        cats.forEach(c => {
            let r = `<tr><td style="text-align:left; font-weight:bold;">${c}</td>`;
            for(let i=1; i<=12; i++) r += `<td><input type="checkbox"></td>`;
            trb.innerHTML += r + `</tr>`;
        });
    </script>
</body>
</html>